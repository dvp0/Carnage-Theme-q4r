{% comment %}
  Product Stock Indicator
  Displays stock availability with urgency messaging
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign inventory_quantity = current_variant.inventory_quantity
  assign inventory_policy = current_variant.inventory_policy
  assign low_stock_threshold = block.settings.low_stock_threshold | default: 10
  assign show_exact_stock = block.settings.show_exact_stock | default: false
-%}

<div class="product-stock-indicator" id="stock-indicator-{{ section.id }}">
  {%- if current_variant.available -%}
    {%- if current_variant.inventory_management == 'shopify' -%}
      {%- if inventory_quantity > 0 -%}
        {%- if inventory_quantity <= low_stock_threshold -%}
          <div class="stock-status stock-status--low">
            <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
              <path d="M8 4V8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <circle cx="8" cy="11" r="0.5" fill="currentColor"/>
            </svg>
            <span class="stock-text">
              {%- if show_exact_stock -%}
                Only {{ inventory_quantity }} left in stock!
              {%- else -%}
                Low stock - order soon!
              {%- endif -%}
            </span>
          </div>
        {%- else -%}
          <div class="stock-status stock-status--in-stock">
            <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
              <path d="M5 8L7 10L11 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="stock-text">
              {%- if show_exact_stock and inventory_quantity < 50 -%}
                {{ inventory_quantity }} in stock
              {%- else -%}
                In stock
              {%- endif -%}
            </span>
          </div>
        {%- endif -%}
      {%- elsif inventory_policy == 'continue' -%}
        <div class="stock-status stock-status--backorder">
          <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
            <path d="M8 4V8L11 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="stock-text">Available on backorder</span>
        </div>
      {%- else -%}
        <div class="stock-status stock-status--out">
          <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
            <path d="M10 6L6 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 6L10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="stock-text">Out of stock</span>
        </div>
      {%- endif -%}
    {%- else -%}
      <div class="stock-status stock-status--in-stock">
        <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
          <path d="M5 8L7 10L11 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="stock-text">In stock</span>
      </div>
    {%- endif -%}
  {%- else -%}
    <div class="stock-status stock-status--out">
      <svg class="stock-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6L6 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 6L10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="stock-text">Out of stock</span>
    </div>
  {%- endif -%}
</div>

<script>
  // Update stock indicator when variant changes
  if (typeof window.ProductStockUpdater === 'undefined') {
    window.ProductStockUpdater = {
      init() {
        document.addEventListener('variant:change', (event) => {
          this.updateStock(event.detail.variant);
        });
      },

      updateStock(variant) {
        const stockIndicator = document.getElementById('stock-indicator-{{ section.id }}');
        if (!stockIndicator || !variant) return;

        // This would be updated via AJAX in a real implementation
        // For now, just show basic availability
        const isAvailable = variant.available;
        const statusEl = stockIndicator.querySelector('.stock-status');

        if (statusEl) {
          statusEl.className = 'stock-status ' + (isAvailable ? 'stock-status--in-stock' : 'stock-status--out');
        }
      }
    };

    window.ProductStockUpdater.init();
  }
</script>
